services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  chat_gateway:
    build:
      context: .
      dockerfile: apps/chat_gateway/Dockerfile
    env_file:
      - .env.example
    environment:
      REDIS_URL: redis://redis:6379/0
      INGEST_STREAM: stream:chat.ingest
      FIREHOSE_STREAM: stream:chat.firehose
      PORT: 8080
      MODERATION_CONFIG: configs/moderation/default.json
    volumes:
      - ./:/app:ro
    ports:
      - "8080:8080"
    depends_on:
      - redis

  persona_workers:
    build:
      context: .
      dockerfile: apps/persona_workers/Dockerfile
    env_file:
      - .env.example
    environment:
      REDIS_URL: redis://redis:6379/0
      FIREHOSE_STREAM: stream:chat.firehose
      INGEST_STREAM: stream:chat.ingest
      ROOM_CONFIG_PATH: configs/rooms/demo.json
      PERSONA_CONFIG_DIR: configs/personas
      HTTP_PORT: 8090
      LOG_LEVEL: INFO
    volumes:
      - ./:/app:ro
    ports:
      - "8090:8090"
    depends_on:
      - redis
      - chat_gateway
    restart: unless-stopped

  stream_perceptor:
    build:
      context: .
      dockerfile: apps/stream_perceptor/Dockerfile
    env_file:
      - .env.example
    environment:
      REDIS_URL: redis://redis:6379/0
      HTTP_PORT: 8100
      STREAM_FRAMES_KEY: stream:frames
      STREAM_TRANSCRIPTS_KEY: stream:transcripts
      STREAM_OBSERVATIONS_KEY: stream:observations
      PROMPT_MANIFEST_PATH: prompts/manifest.json
      LLM_PROVIDER_CONFIG_PATH: configs/llm/providers/stub.json
      LOG_LEVEL: INFO
    volumes:
      - ./:/app:ro
    ports:
      - "8100:8100"
    depends_on:
      - redis
    restart: unless-stopped

  web_ui:
    image: nginx:alpine
    volumes:
      - ./apps/web_ui:/usr/share/nginx/html:ro
    ports:
      - "5173:80"
    depends_on:
      - chat_gateway

  stub_publisher:
    image: python:3.11-slim
    working_dir: /app
    command: python apps/tools/stub_publisher/publish.py --redis-url redis://redis:6379/0 --rate 10
    volumes:
      - ./:/app:ro
    depends_on:
      - redis
    profiles: ["publisher"]
