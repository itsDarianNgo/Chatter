name: Protocol Validation

on:
  push:
  pull_request:

jobs:
  validate-protocol:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        working-directory: ./chatter
        run: pip install .

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Node dependencies
        working-directory: ./chatter
        run: npm ci

      - name: Validate artifacts
        working-directory: ./chatter
        run: npm run validate:artifacts

      - name: Build and start compose services
        working-directory: ./chatter
        run: docker compose up -d --build

      - name: Wait for gateway health
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8080/healthz >/dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "Gateway did not become healthy" >&2
          exit 1

      - name: Start persona_workers
        working-directory: ./chatter
        run: |
          REDIS_URL=redis://localhost:6379/0 \
          FIREHOSE_STREAM=stream:chat.firehose \
          INGEST_STREAM=stream:chat.ingest \
          ROOM_CONFIG_PATH=configs/rooms/demo.json \
          PERSONA_CONFIG_DIR=configs/personas \
          HTTP_PORT=8090 \
          python -m apps.persona_workers.src.main > /tmp/pw.log 2>&1 &
          echo $! > /tmp/pw.pid

      - name: Wait for persona_workers health
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8090/healthz >/dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "persona_workers did not become healthy" >&2
          echo "---- persona_workers logs ----" >&2
          cat /tmp/pw.log >&2
          exit 1

      - name: Run WebSocket firehose e2e test
        working-directory: ./chatter
        run: npm run test:e2e

      - name: Run botloop e2e test
        working-directory: ./chatter
        run: npm run test:e2e:botloop

      - name: Cleanup services
        if: always()
        working-directory: ./chatter
        run: |
          if [ -f /tmp/pw.pid ]; then
            kill $(cat /tmp/pw.pid) 2>/dev/null || true
          fi
          docker compose down -v
