{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://chatter.local/schemas/stream_context.schema.json",
  "title": "StreamContext",
  "type": "object",
  "additionalProperties": true,
  "required": [
    "schema_name",
    "schema_version",
    "id",
    "ts",
    "room_id",
    "sequence",
    "transcript_window",
    "events",
    "keywords",
    "summary"
  ],
  "properties": {
    "schema_name": { "const": "StreamContext" },
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semver-like schema version (e.g., 1.0.0)."
    },
    "id": {
      "type": "string",
      "minLength": 8,
      "maxLength": 128,
      "description": "Globally unique message id (ULID/UUID recommended)."
    },
    "ts": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp (ISO-8601)."
    },
    "room_id": {
      "type": "string",
      "pattern": "^room:[A-Za-z0-9._-]{1,128}$",
      "description": "Room scope identifier."
    },
    "sequence": {
      "type": "integer",
      "minimum": 0,
      "description": "Monotonically increasing per room (best-effort)."
    },
    "transcript_window": {
      "type": "array",
      "items": { "$ref": "#/$defs/TranscriptSegment" },
      "description": "Recent speech window (typically 20–60 seconds)."
    },
    "events": {
      "type": "array",
      "items": { "$ref": "#/$defs/StreamEvent" },
      "description": "Structured stream events (may be empty)."
    },
    "keywords": {
      "type": "array",
      "items": { "type": "string", "minLength": 1, "maxLength": 64 },
      "maxItems": 64,
      "description": "Compact topical cues for agents."
    },
    "summary": {
      "type": "string",
      "minLength": 1,
      "maxLength": 512,
      "description": "Short human-readable summary (1–3 lines)."
    },
    "scene": {
      "type": ["string", "null"],
      "maxLength": 128,
      "description": "Optional scene label."
    },
    "debug": {
      "type": ["object", "null"],
      "additionalProperties": true,
      "description": "Optional internal debug data (avoid in production)."
    }
  },
  "$defs": {
    "TranscriptSegment": {
      "type": "object",
      "additionalProperties": true,
      "required": ["t0_ms", "t1_ms", "text"],
      "properties": {
        "t0_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Relative start time (ms) within the window."
        },
        "t1_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Relative end time (ms) within the window."
        },
        "text": {
          "type": "string",
          "minLength": 1,
          "maxLength": 2048,
          "description": "Transcript chunk."
        },
        "speaker": {
          "type": ["string", "null"],
          "maxLength": 64,
          "description": "Optional speaker label."
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Optional ASR confidence (0–1)."
        }
      }
    },
    "StreamEvent": {
      "type": "object",
      "additionalProperties": true,
      "required": ["type", "strength", "ts"],
      "properties": {
        "type": {
          "type": "string",
          "minLength": 1,
          "maxLength": 64,
          "description": "Event type (extensible)."
        },
        "strength": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Event strength (0–1)."
        },
        "ts": {
          "type": "string",
          "format": "date-time",
          "description": "Event timestamp."
        },
        "meta": {
          "type": "object",
          "additionalProperties": true,
          "description": "Optional event metadata."
        }
      }
    }
  },
  "examples": [
    {
      "schema_name": "StreamContext",
      "schema_version": "1.0.0",
      "id": "01JH7Y0J1S0J2R1K9F1Y2YQZ9A",
      "ts": "2025-12-12T20:15:05.123Z",
      "room_id": "room:mychannel",
      "sequence": 1842,
      "transcript_window": [
        { "t0_ms": 0, "t1_ms": 4200, "text": "Alright chat, do we go left or right here?", "speaker": "streamer", "confidence": 0.92 }
      ],
      "events": [
        { "type": "chat_question", "strength": 0.85, "ts": "2025-12-12T20:15:04.900Z", "meta": { "question": "left or right" } }
      ],
      "keywords": ["decision", "route", "left", "right"],
      "summary": "Streamer asks chat to decide: left or right route.",
      "scene": "gameplay"
    }
  ]
}
